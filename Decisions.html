<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>People of the World – Decision Game</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    :root {
      --pow-bg: #f4f5fb;
      --pow-accent: #1c8fa9;
      --pow-accent-soft: #e0f3f7;
      --pow-text: #222;
      --pow-muted: #666;
      --pow-card-bg: #ffffff;
      --pow-danger: #c0392b;
      --pow-success: #27ae60;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--pow-bg);
      color: var(--pow-text);
    }

    #pow-decision-game {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
    }

    .pow-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .pow-header-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .pow-mode-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #e4e6f0;
      color: var(--pow-text);
      font-weight: 500;
      transition: background 0.15s, transform 0.05s;
      white-space: nowrap;
    }

    button:hover { background: #d5d7e5; }
    button:active { transform: scale(0.97); }

    button.pow-primary {
      background: var(--pow-accent);
      color: #fff;
    }
    button.pow-primary:hover { background: #147187; }

    button.pow-ghost {
      background: transparent;
      border: 1px solid #cfd3e5;
    }

    button.pow-danger {
      background: var(--pow-danger);
      color: #fff;
    }
    button.pow-danger:hover { background: #962d22; }

    .pow-status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px;
      border-radius: 16px;
      background: var(--pow-accent-soft);
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .pow-status-item {
      min-width: 110px;
    }

    .pow-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--pow-muted);
      margin-bottom: 2px;
      /* hide labels from player */
      display: none;
    }

    .pow-value { font-weight: 600; }

    .pow-play-area {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
      align-items: stretch;
    }

    .pow-card {
      flex: 1;
      background: var(--pow-card-bg);
      border-radius: 20px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .pow-word {
      font-size: 2.1rem;
      font-weight: 700;
      text-align: center;
      word-wrap: break-word;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pow-image-wrapper {
      position: relative;
      width: 100%;
      padding-top: 70%;
      overflow: hidden;
      border-radius: 16px;
      background: #f8f8fc;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pow-image-wrapper img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .pow-relation-card {
      flex: 0 0 140px; /* wider so "is not" fits comfortably */
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    .pow-relation-label {
      width: 100%;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      color: #333;
      word-wrap: break-word;
      white-space: normal;   /* allow "is not" to wrap to two lines if needed */
      line-height: 1.1;
    }

    .pow-relation-not {
      color: var(--pow-danger);
    }

    .pow-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .pow-actions button {
      flex: 1;
      padding: 12px 18px;
      font-size: 1.1rem;
    }

    .pow-actions .false {
      background: #f7d7d7;
      color: #b03030;
    }
    .pow-actions .false:hover { background: #f1c0c0; }

    .pow-actions .true {
      background: #d5f3dd;
      color: #227a3b;
    }
    .pow-actions .true:hover { background: #beeac9; }

    .pow-helper-text {
      font-size: 0.75rem;
      color: var(--pow-muted);
      margin-bottom: 8px;
    }

    .pow-summary {
      background: var(--pow-card-bg);
      border-radius: 16px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      font-size: 0.9rem;
    }

    .pow-summary-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .pow-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .pow-summary-highlight {
      color: var(--pow-success);
      font-weight: 600;
    }

    .pow-leaderboard-section {
      background: var(--pow-card-bg);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      font-size: 0.85rem;
    }

    .pow-leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pow-leaderboard-title { font-weight: 600; }

    .pow-leaderboard-table-wrapper {
      max-height: 280px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e0e2f0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f5f6ff;
      z-index: 1;
    }

    th, td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid #f0f1f7;
    }

    th {
      font-weight: 600;
      color: var(--pow-muted);
      font-size: 0.75rem;
    }

    tbody tr:nth-child(odd) { background: #fafbff; }

    .pow-tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e0f3f7;
      color: #256773;
    }

    .pow-message {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--pow-muted);
    }

    .pow-message.highlight {
      color: var(--pow-success);
    }

    .pow-warning {
      font-size: 0.8rem;
      color: var(--pow-danger);
      margin-bottom: 6px;
      display: none;
    }

    /* Modal for instructions */
    .pow-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .pow-modal {
      max-width: 520px;
      width: 92%;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.18);
      padding: 16px 18px 14px;
    }

    .pow-modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .pow-modal-sub {
      font-size: 0.85rem;
      color: var(--pow-muted);
      margin-bottom: 10px;
    }

    .pow-modal-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .pow-modal-text {
      font-size: 0.8rem;
      color: var(--pow-text);
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .pow-modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .pow-modal-footer button {
      padding: 6px 16px;
      font-size: 0.9rem;
    }

    /* ---------- Mobile tweaks ---------- */
    @media (max-width: 768px) {
      .pow-header-title {
        font-size: 1.1rem;
      }

      .pow-play-area {
        gap: 6px;
        margin-bottom: 6px;
      }

      .pow-card {
        padding: 8px;
      }

      .pow-word {
        font-size: 1.4rem;
      }

      .pow-image-wrapper {
        padding-top: 55%; /* shallower so buttons stay in view */
      }

      .pow-relation-card {
        flex: 0 0 110px;
      }

      .pow-relation-label {
        font-size: 1.4rem;
      }

      .pow-actions {
        margin-bottom: 6px;
      }

      .pow-actions button {
        padding: 10px 8px;
        font-size: 0.95rem;
      }

      .pow-status-bar {
        gap: 4px;
        padding: 4px;
        font-size: 0.75rem;
      }

      .pow-status-item {
        min-width: 90px;
      }

      .pow-helper-text {
        font-size: 0.7rem;
      }
    }

    @media (max-width: 520px) {
      .pow-play-area {
        gap: 4px;
        margin-bottom: 4px;
      }

      .pow-card {
        padding: 6px;
        border-radius: 16px;
      }

      .pow-word {
        font-size: 1.1rem;
      }

      .pow-image-wrapper {
        padding-top: 40%; /* even shallower on very small screens */
      }

      .pow-relation-card {
        flex: 0 0 90px;
      }

      .pow-relation-label {
        font-size: 1.2rem;
      }

      .pow-status-bar {
        font-size: 0.7rem;
        margin-bottom: 6px;
      }

      .pow-status-item {
        min-width: 80px;
      }

      .pow-actions {
        margin-bottom: 6px;
      }

      .pow-actions button {
        font-size: 0.9rem;
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>
<div id="pow-decision-game">
<div class="pow-header">
<div class="pow-header-title">Test and Improve Your Decision Making</div>
<div class="pow-mode-buttons">
<button class="pow-ghost" id="modeToggleButton">Mode: Short (10)</button>
<button class="pow-ghost" id="newPlayerButton">New Player</button>
<button class="pow-primary" id="startStopButton">Start</button>
</div>
</div>
<div class="pow-warning" id="orientationWarning">
    For best experience on mobile, rotate your device to landscape.
  </div>
<!-- PLAY AREA: picture (left) – relation (middle) – word (right) -->
<div class="pow-play-area">
<!-- Picture LEFT -->
<div class="pow-card">
<div class="pow-image-wrapper">
<img alt="Decision picture" id="pictureDisplay"/>
</div>
</div>
<!-- Relation MIDDLE -->
<div class="pow-card pow-relation-card">
<div class="pow-relation-label" id="relationLabel">is</div>
</div>
<!-- Word RIGHT -->
<div class="pow-card">
<div class="pow-word" id="wordDisplay">Press Start</div>
</div>
</div>
<div class="pow-actions">
<button class="false" id="falseButton">False</button>
<button class="true" id="trueButton">True</button>
</div>
<div class="pow-status-bar">
<div class="pow-status-item">
<div class="pow-label">Mode</div>
<div class="pow-value" id="statusMode">Short (10)</div>
</div>
<div class="pow-status-item">
<div class="pow-label">Question</div>
<div class="pow-value" id="statusQuestion">0 / 10</div>
</div>
<div class="pow-status-item">
<div class="pow-label">Session Time</div>
<div class="pow-value" id="statusTotalTime">0.00s</div>
</div>
<div class="pow-status-item">
<div class="pow-label">Avg Reaction</div>
<div class="pow-value" id="statusAvgTime">0.00s</div>
</div>
<div class="pow-status-item">
<div class="pow-label">Correct</div>
<div class="pow-value" id="statusCorrect">0</div>
</div>
<div class="pow-status-item">
<div class="pow-label">Incorrect</div>
<div class="pow-value" id="statusIncorrect">0</div>
</div>
</div>
<div class="pow-helper-text" id="helperText">
    Tap <strong>Mode</strong> to switch between Practice / Short / Long / Infinite,
    then press <strong>Start</strong>.<br/>
    You see a <strong>picture on the left</strong>, a middle box that says
    <strong>“is”</strong> or <strong>“is not”</strong>, and a <strong>word on the right</strong>.<br/>
    Answer <strong>True</strong> if that full sentence is correct.<br/>
    On desktop: <strong>Left Arrow = False</strong>, <strong>Right Arrow = True</strong>.
  </div>
<div class="pow-summary" id="summaryPanel" style="display: none;">
<div class="pow-summary-title">Run Summary</div>
<div class="pow-summary-row">
<span>Mode</span>
<span id="summaryMode"></span>
</div>
<div class="pow-summary-row">
<span>Questions</span>
<span id="summaryQuestions"></span>
</div>
<div class="pow-summary-row">
<span>Correct</span>
<span id="summaryCorrect"></span>
</div>
<div class="pow-summary-row">
<span>Incorrect</span>
<span id="summaryIncorrect"></span>
</div>
<div class="pow-summary-row">
<span>Total time</span>
<span id="summaryTotalTime"></span>
</div>
<div class="pow-summary-row">
<span>Average reaction</span>
<span id="summaryAvgTime"></span>
</div>
<div class="pow-summary-row">
<span>Your best (this mode)</span>
<span id="summaryBest"></span>
</div>
<div class="pow-message" id="summaryMessage"></div>
</div>
<div class="pow-leaderboard-section pow-leaderboard">
<div class="pow-leaderboard-header">
<div>
<div class="pow-leaderboard-title">
          Leaderboard <span class="pow-tag" id="leaderboardModeLabel">Short</span>
</div>
<div class="pow-message" id="leaderboardRankingInfo">
          Ranked by fewest mistakes, then total time, then average reaction.
        </div>
</div>
<div>
<button class="pow-primary" id="leaderboardToggleButton">
          View: Short
        </button>
</div>
</div>
<div class="pow-leaderboard-table-wrapper">
<table>
<thead>
<tr>
<th>#</th>
<th>Initials</th>
<th>Q</th>
<th>C</th>
<th>IC</th>
<th>Total (s)</th>
<th>Avg (s)</th><th>Date</th>
</tr>
</thead>
<tbody id="leaderboardBody"></tbody>
</table>
</div>
</div>
</div>
<!-- Instructions modal -->
<div class="pow-modal-backdrop" id="instructionsModal" style="display:flex;">
<div class="pow-modal">
<div class="pow-modal-title">Welcome to the POW Decision Game</div>
<div class="pow-modal-sub">
      Train your moment-to-moment decision making with fast, honest feedback.
    </div>
<div class="pow-modal-section-title">How it works</div>
<div class="pow-modal-text">
      You see a <strong>picture on the left</strong>, a middle box that says
      <strong>“is”</strong> or <strong style="color:#c0392b;">“is not”</strong>,
      and a <strong>word on the right</strong>.
    </div>
<div class="pow-modal-text">
      Your job is to decide if the full sentence is <strong>true or false</strong>.
    </div>
<div class="pow-modal-section-title">Controls</div>
<div class="pow-modal-text">
      • Tap / click the <strong>True</strong> or <strong>False</strong> buttons.<br/>
      • On desktop you can also use:
      <strong>Left Arrow → False</strong>, <strong>Right Arrow → True</strong>.
    </div>
<div class="pow-modal-section-title">Modes</div>
<div class="pow-modal-text">
      • <strong>Practice</strong>: Infinite questions, just train. Time and average reaction are shown, but not ranked.<br/>
      • <strong>Short</strong>: 10 questions, recorded and ranked locally.<br/>
      • <strong>Long</strong>: 20 questions, recorded and ranked separately.<br/>
      • <strong>Infinite</strong>: Keeps going until your <strong>first mistake or timeout</strong>.
      The allowed time per question starts at <strong>1.0s</strong> and gets
      <strong>0.1s shorter every 50 correct answers</strong>, down to a minimum of <strong>0.3s</strong>.
    </div>
<div class="pow-modal-section-title">Scoring &amp; sounds</div>
<div class="pow-modal-text">
      • You get a <strong>green ding</strong> for a correct answer.<br/>
      • A <strong>low buzzer</strong> means the answer (or timeout) was wrong.<br/>
      • A <strong>start bell</strong> plays after the 3-2-1 countdown.<br/>
      • A <strong>finish bell</strong> plays at the end of each run.
    </div>
<div class="pow-modal-text">
      Locally, the leaderboard keeps only your <strong>best score per mode</strong>:
      for Short/Long it ranks by fewest mistakes, then total time, then average reaction.
      For Infinite it ranks by most correct, then average reaction, then total time.
    </div>
<div class="pow-modal-footer">
<button class="pow-primary" id="instructionsCloseBtn">Got it</button>
</div>
</div>
</div>
<script>
(function() {
  const ITEMS = [
    { key: "ball", label: "Ball", url: "https://static.wixstatic.com/media/eaef6d_7f2b9555f08e4407bcf27857bf332d3c~mv2.png" },
    { key: "umbrella", label: "Umbrella", url: "https://static.wixstatic.com/media/eaef6d_a783bbb23e2f4960a84c5946322bd1d1~mv2.png" },
    { key: "pig", label: "Pig", url: "https://static.wixstatic.com/media/eaef6d_12d8e64c3bbb45749e7d2328b1ea3329~mv2.png" },
    { key: "butterfly", label: "Butterfly", url: "https://static.wixstatic.com/media/eaef6d_87217c52f3b44756834c0cc47ddb62fc~mv2.png" },
    { key: "airplane", label: "Airplane", url: "https://static.wixstatic.com/media/eaef6d_fd2e5d6a21154331aad70d6079dce246~mv2.png" },
    { key: "car", label: "Car", url: "https://static.wixstatic.com/media/eaef6d_ce7258f9c42342c49453582be5a69c88~mv2.png" },
    { key: "mouse", label: "Mouse", url: "https://static.wixstatic.com/media/eaef6d_cb46105a23d049808c595598fe7d883f~mv2.png" },
    { key: "hat", label: "Hat", url: "https://static.wixstatic.com/media/eaef6d_bb22e0b78d134c88bb6c67d4941ece27~mv2.png" },
    { key: "house", label: "House", url: "https://static.wixstatic.com/media/eaef6d_6ece4136d1ec4dc8bf3f51c8e244766b~mv2.png" },
    { key: "cow", label: "Cow", url: "https://static.wixstatic.com/media/eaef6d_df0c98fc5b28458db695aa5cb3d414a8~mv2.png" },
    { key: "bus", label: "Bus", url: "https://static.wixstatic.com/media/eaef6d_64f8949a66c14145948d1cb0db7e7224~mv2.png" },
    { key: "tree", label: "Tree", url: "https://static.wixstatic.com/media/eaef6d_0fd2bc64878e41a299cc22c3f0a35abf~mv2.png" },
    { key: "flower", label: "Flower", url: "https://static.wixstatic.com/media/eaef6d_8cf53ea56de040f2b2ceecfe2a2619b4~mv2.png" },
    { key: "bee", label: "Bee", url: "https://static.wixstatic.com/media/eaef6d_8f18d62b58914a7085530ea3d3183901~mv2.png" },
    { key: "cup", label: "Cup", url: "https://static.wixstatic.com/media/eaef6d_633ee54b4fd9427bb9ef5a3d2e027fe3~mv2.png" },
    { key: "ballerina", label: "Ballerina", url: "https://static.wixstatic.com/media/eaef6d_2a8b7bce57d24700b5bd133da2da1dd1~mv2.png" },
    { key: "bird", label: "Bird", url: "https://static.wixstatic.com/media/eaef6d_653bf4fd82f94aff94796803666e80de~mv2.png" },
    { key: "chair", label: "Chair", url: "https://static.wixstatic.com/media/eaef6d_3b4a0f88dd6d4ba485ed22d103eabf2a~mv2.png" },
    { key: "book", label: "Book", url: "https://static.wixstatic.com/media/eaef6d_f0408751e9a640d88066b46722a8ea91~mv2.png" },
    { key: "cherry", label: "Cherry", url: "https://static.wixstatic.com/media/eaef6d_97c92754a41d489eb0bb984377487207~mv2.png" }
  ];

  const STORAGE_KEY = "powDecisionGameStats_v2"; // bump version due to infinite mode

  const el = {
    modeToggleButton: document.getElementById("modeToggleButton"),
    startStopButton: document.getElementById("startStopButton"),
    statusMode: document.getElementById("statusMode"),
    statusQuestion: document.getElementById("statusQuestion"),
    statusTotalTime: document.getElementById("statusTotalTime"),
    statusAvgTime: document.getElementById("statusAvgTime"),
    statusCorrect: document.getElementById("statusCorrect"),
    statusIncorrect: document.getElementById("statusIncorrect"),
    wordDisplay: document.getElementById("wordDisplay"),
    pictureDisplay: document.getElementById("pictureDisplay"),
    relationLabel: document.getElementById("relationLabel"),
    falseButton: document.getElementById("falseButton"),
    trueButton: document.getElementById("trueButton"),
    summaryPanel: document.getElementById("summaryPanel"),
    summaryMode: document.getElementById("summaryMode"),
    summaryQuestions: document.getElementById("summaryQuestions"),
    summaryCorrect: document.getElementById("summaryCorrect"),
    summaryIncorrect: document.getElementById("summaryIncorrect"),
    summaryTotalTime: document.getElementById("summaryTotalTime"),
    summaryAvgTime: document.getElementById("summaryAvgTime"),
    summaryBest: document.getElementById("summaryBest"),
    summaryMessage: document.getElementById("summaryMessage"),
    leaderboardBody: document.getElementById("leaderboardBody"),
    leaderboardModeLabel: document.getElementById("leaderboardModeLabel"),
    leaderboardToggleButton: document.getElementById("leaderboardToggleButton"),
    leaderboardRankingInfo: document.getElementById("leaderboardRankingInfo"),
    orientationWarning: document.getElementById("orientationWarning"),
    instructionsModal: document.getElementById("instructionsModal"),
    instructionsCloseBtn: document.getElementById("instructionsCloseBtn")
  };

  /* ---- Audio ---- */
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;

  function getAudioCtx() {
    if (!AudioCtx) return null;
    if (!audioCtx) {
      try { audioCtx = new AudioCtx(); } catch (e) { audioCtx = null; }
    }
    return audioCtx;
  }

  function playTone(freq, duration, volume) {
    const ctx = getAudioCtx();
    if (!ctx) return;
    try {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      gain.gain.value = volume;
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      osc.start(now);
      osc.stop(now + duration);
    } catch (e) {}
  }

  function playCountdownBeep(stepIndex) {
    const base = 600;
    playTone(base + stepIndex * 80, 0.15, 0.25);
  }

  function playStartBell() {
    playTone(1000, 0.22, 0.3);
  }

  function playCorrectDing() {
    playTone(880, 0.12, 0.28);
  }

  function playFinishBell() {
    playTone(900, 0.16, 0.25);
    setTimeout(() => playTone(700, 0.18, 0.22), 180);
  }

  function playWrongBuzz() {
    const ctx = getAudioCtx();
    if (!ctx) return;
    try {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = 260;
      gain.gain.value = 0.22;
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      osc.start(now);
      osc.stop(now + 0.18);
    } catch (e) {}
  }

  /* ---- Game state ---- */
  let currentMode = "short"; // practice | short | long | infinite
  let targetQuestions = 10;
  let questionCount = 0;
  let correctCount = 0;
  let incorrectCount = 0;
  let sessionStartTime = null;
  let lastQuestionTime = null;
  let totalReactionTime = 0;
  let timerInterval = null;
  let currentCorrectAnswer = null;
  let currentQuestionActive = false;
  let runActive = false;

  let wordOrder = [];
  let pictureOrder = [];

  let lastWordIndex = null;
  let lastPictureIndex = null;

  let lastIsNot = null;
  let relationStreak = 0;

  let countdownActive = false;
  let countdownTimers = [];

  let leaderboardViewMode = "short";
  let stats = loadStats();

  // Infinite mode timing
  const INFINITE_BASE_TIME_LIMIT = 1.0; // seconds
  const INFINITE_MIN_TIME_LIMIT = 0.3;
  let infiniteTimeLimit = INFINITE_BASE_TIME_LIMIT;
  let questionTimeoutId = null;

  function clearCountdownTimers() {
    countdownTimers.forEach(id => clearTimeout(id));
    countdownTimers = [];
  }

  function clearQuestionTimeout() {
    if (questionTimeoutId !== null) {
      clearTimeout(questionTimeoutId);
      questionTimeoutId = null;
    }
  }

  function updateInfiniteTimeLimit() {
    // For each 50 correct answers, drop 0.1s, down to 0.3s
    const steps = Math.floor(correctCount / 50);
    const candidate = INFINITE_BASE_TIME_LIMIT - 0.1 * steps;
    infiniteTimeLimit = candidate < INFINITE_MIN_TIME_LIMIT ? INFINITE_MIN_TIME_LIMIT : candidate;
  }

  function loadStats() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return {
          playerInitials: "",
          runs: {
            short: { firstRun: null, bestRun: null, lastRun: null },
            long: { firstRun: null, bestRun: null, lastRun: null },
            infinite: { firstRun: null, bestRun: null, lastRun: null }
          },
          leaderboard: {
            short: [],
            long: [],
            infinite: []
          }
        };
      }
      const parsed = JSON.parse(raw);

      if (!parsed.runs) {
        parsed.runs = {
          short: { firstRun: null, bestRun: null, lastRun: null },
          long: { firstRun: null, bestRun: null, lastRun: null },
          infinite: { firstRun: null, bestRun: null, lastRun: null }
        };
      } else {
        if (!parsed.runs.short) parsed.runs.short = { firstRun: null, bestRun: null, lastRun: null };
        if (!parsed.runs.long) parsed.runs.long = { firstRun: null, bestRun: null, lastRun: null };
        if (!parsed.runs.infinite) parsed.runs.infinite = { firstRun: null, bestRun: null, lastRun: null };
      }

      if (!parsed.leaderboard) {
        parsed.leaderboard = { short: [], long: [], infinite: [] };
      } else {
        if (!parsed.leaderboard.short) parsed.leaderboard.short = [];
        if (!parsed.leaderboard.long) parsed.leaderboard.long = [];
        if (!parsed.leaderboard.infinite) parsed.leaderboard.infinite = [];
      }

      if (parsed.playerInitials === "???") parsed.playerInitials = "";

      return parsed;
    } catch (e) {
      return {
        playerInitials: "",
        runs: {
          short: { firstRun: null, bestRun: null, lastRun: null },
          long: { firstRun: null, bestRun: null, lastRun: null },
          infinite: { firstRun: null, bestRun: null, lastRun: null }
        },
        leaderboard: { short: [], long: [], infinite: [] }
      };
    }
  }

  function saveStats() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
    } catch (e) {}
  }

  function formatSeconds(sec) {
    if (!isFinite(sec) || sec < 0) return "0.00s";
    return sec.toFixed(2) + "s";
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = arr[i];
      arr[i] = arr[j];
      arr[j] = temp;
    }
    return arr;
  }

  function resetState() {
    clearCountdownTimers();
    countdownActive = false;
    clearQuestionTimeout();

    questionCount = 0;
    correctCount = 0;
    incorrectCount = 0;
    totalReactionTime = 0;
    sessionStartTime = null;
    lastQuestionTime = null;
    currentCorrectAnswer = null;
    currentQuestionActive = false;
    runActive = false;
    clearInterval(timerInterval);
    timerInterval = null;

    wordOrder = [];
    pictureOrder = [];
    lastWordIndex = null;
    lastPictureIndex = null;

    lastIsNot = null;
    relationStreak = 0;
    infiniteTimeLimit = INFINITE_BASE_TIME_LIMIT;

    el.statusTotalTime.textContent = "0.00s";
    el.statusAvgTime.textContent = "0.00s";
    el.statusCorrect.textContent = "0";
    el.statusIncorrect.textContent = "0";
    el.statusQuestion.textContent =
      "0 / " + (isFinite(targetQuestions) ? targetQuestions : "∞");

    el.summaryPanel.style.display = "none";
    el.summaryMessage.textContent = "";
    el.wordDisplay.textContent = "Press Start";
    el.relationLabel.textContent = "is";
    el.relationLabel.classList.remove("pow-relation-not");

    el.startStopButton.textContent = "Start";

    if (ITEMS.length > 0) {
      const idx = Math.floor(Math.random() * ITEMS.length);
      const item = ITEMS[idx];
      el.pictureDisplay.src = item.url;
      el.pictureDisplay.alt = item.label;
    } else {
      el.pictureDisplay.src = "";
      el.pictureDisplay.alt = "Decision picture";
    }
  }

  function applyModeUI() {
    let label;
    if (currentMode === "practice") {
      label = "Mode: Practice";
      el.statusMode.textContent = "Practice";
      el.statusQuestion.textContent = "0 / ∞";
    } else if (currentMode === "short") {
      label = "Mode: Short (10)";
      el.statusMode.textContent = "Short (10)";
      el.statusQuestion.textContent = "0 / 10";
    } else if (currentMode === "long") {
      label = "Mode: Long (20)";
      el.statusMode.textContent = "Long (20)";
      el.statusQuestion.textContent = "0 / 20";
    } else {
      label = "Mode: Infinite";
      el.statusMode.textContent = "Infinite";
      el.statusQuestion.textContent = "0 / ∞";
    }
    el.modeToggleButton.textContent = label;
  }

  function setMode(mode) {
    if (runActive || countdownActive) {
      stopRun(true);
    }
    currentMode = mode;
    if (mode === "practice") {
      targetQuestions = Infinity;
    } else if (mode === "short") {
      targetQuestions = 10;
    } else if (mode === "long") {
      targetQuestions = 20;
    } else {
      targetQuestions = Infinity;
    }
    applyModeUI();
  }

  // --- UI wiring & minimal initialization (only essential parts included) ---
  // Add the modal close behavior so the Got it button hides the modal.
  if (el.instructionsCloseBtn) {
    el.instructionsCloseBtn.addEventListener('click', function() {
      if (el.instructionsModal) {
        el.instructionsModal.style.display = 'none';
      }
      // After closing instructions, focus the Start button for convenience
      if (el.startStopButton) el.startStopButton.focus();
    });
  }

  // Basic mode toggle for convenience
  if (el.modeToggleButton) {
    el.modeToggleButton.addEventListener('click', function() {
      const modes = ['practice', 'short', 'long', 'infinite'];
      const idx = modes.indexOf(currentMode);
      const next = modes[(idx + 1) % modes.length];
      setMode(next);
    });
  }

  // Wire start/stop so you can at least start a run or reset state (minimal)
  if (el.startStopButton) {
    el.startStopButton.addEventListener('click', function() {
      if (runActive) {
        stopRun(false);
      } else {
        startRun();
      }
    });
  }

  // Basic true/false wiring to allow playing once script runs
  if (el.trueButton) {
    el.trueButton.addEventListener('click', function() {
      if (currentQuestionActive) answerQuestion(true);
    });
  }
  if (el.falseButton) {
    el.falseButton.addEventListener('click', function() {
      if (currentQuestionActive) answerQuestion(false);
    });
  }

  // Keyboard arrows
  window.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      if (currentQuestionActive) answerQuestion(false);
    } else if (e.key === 'ArrowRight') {
      if (currentQuestionActive) answerQuestion(true);
    }
  });

  // Stubs for functions referenced above but not included in this snippet.
  // The goal here is to ensure the script parses and the modal button works.
  // If your original file contains fuller implementations, keep them; otherwise
  // these simple stubs prevent runtime errors until you reintroduce the full logic.
  function startRun() {
    // minimal start behavior: set flags and swap button label
    runActive = true;
    currentQuestionActive = false;
    questionCount = 0;
    correctCount = 0;
    incorrectCount = 0;
    sessionStartTime = Date.now();
    el.startStopButton.textContent = "Stop";
    el.statusQuestion.textContent = "0 / " + (isFinite(targetQuestions) ? targetQuestions : "∞");
    // prepare first question (simplified)
    nextQuestion();
  }

  function stopRun(force) {
    // minimal stop behavior: reset flags and show summary
    runActive = false;
    currentQuestionActive = false;
    clearCountdownTimers();
    clearQuestionTimeout();
    el.startStopButton.textContent = "Start";
    // show summary
    el.summaryPanel.style.display = "block";
    el.summaryMode.textContent = el.statusMode.textContent;
    el.summaryQuestions.textContent = questionCount;
    el.summaryCorrect.textContent = correctCount;
    el.summaryIncorrect.textContent = incorrectCount;
    if (sessionStartTime) {
      const totalSec = (Date.now() - sessionStartTime) / 1000;
      el.summaryTotalTime.textContent = formatSeconds(totalSec);
      el.summaryAvgTime.textContent = formatSeconds(totalReactionTime / Math.max(1, questionCount));
    } else {
      el.summaryTotalTime.textContent = "0.00s";
      el.summaryAvgTime.textContent = "0.00s";
    }
  }

  function nextQuestion() {
    // simplified question cycle: pick random item and show word/picture/relation
    if (!runActive) return;
    questionCount++;
    el.statusQuestion.textContent = questionCount + " / " + (isFinite(targetQuestions) ? targetQuestions : "∞");
    const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
    el.pictureDisplay.src = item.url;
    el.pictureDisplay.alt = item.label;
    // randomly choose true/false and relation label
    const isNot = Math.random() < 0.5;
    el.relationLabel.textContent = isNot ? "is not" : "is";
    if (isNot) el.relationLabel.classList.add('pow-relation-not');
    else el.relationLabel.classList.remove('pow-relation-not');
    el.wordDisplay.textContent = item.label; // simplistic: show same label
    // set correct answer randomly for demo (your full logic should compute this)
    currentCorrectAnswer = Math.random() < 0.5;
    currentQuestionActive = true;
    lastQuestionTime = Date.now();
    // if infinite mode, set timeout based on infiniteTimeLimit
    if (currentMode === 'infinite') {
      updateInfiniteTimeLimit();
      clearQuestionTimeout();
      questionTimeoutId = setTimeout(function() {
        // timeout considered incorrect
        currentQuestionActive = false;
        incorrectCount++;
        el.statusIncorrect.textContent = String(incorrectCount);
        playWrongBuzz();
        if (currentMode === 'infinite') stopRun(false);
      }, infiniteTimeLimit * 1000);
    }
  }

  function answerQuestion(choice) {
    if (!currentQuestionActive) return;
    clearQuestionTimeout();
    currentQuestionActive = false;
    const now = Date.now();
    const reaction = (now - lastQuestionTime) / 1000;
    totalReactionTime += reaction;
    if (choice === currentCorrectAnswer) {
      correctCount++;
      el.statusCorrect.textContent = String(correctCount);
      playCorrectDing();
    } else {
      incorrectCount++;
      el.statusIncorrect.textContent = String(incorrectCount);
      playWrongBuzz();
    }
    el.statusAvgTime.textContent = formatSeconds(totalReactionTime / Math.max(1, correctCount + incorrectCount));
    if (isFinite(targetQuestions) && questionCount >= targetQuestions) {
      // run finished
      stopRun(false);
      playFinishBell();
    } else if (currentMode === 'infinite' && incorrectCount > 0) {
      stopRun(false);
    } else {
      // proceed to next question after a short delay
      setTimeout(nextQuestion, 350);
    }
  }

  // Initialize UI and display a random picture
  resetState();
  applyModeUI();

  // If you want the modal to auto-hide for returning users, you can check stats or another flag here.
})();
</script>
</body>
</html>
